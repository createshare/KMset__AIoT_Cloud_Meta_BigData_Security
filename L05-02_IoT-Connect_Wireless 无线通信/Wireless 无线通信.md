# Wireless 无线通信

# ■■■■■■■■■■■■■■■■■■■■■■

# 无线通信的基础概念

## 宽带

在通信业里，带宽可能有两个意义。一个是频带宽度，简称带宽，单位是Hz。

另外一个网络的最大传输速率,单位是 bps。

而宽带则是一个人为定义的，没有严格标准的名词。宽带是一个相对于窄带而言的概念。宽带网，简单地说，就是指高带宽的网络。通常，人们把骨干网传输速率在 2.5G 以上，接入网能够达到1兆的网络定义为"宽带网"。

与传统的窄带网络相比，宽带网在速度上占据极大的优势，它可以为上网者提供更为平滑的视频图像，更为清晰逼真的声音效果和更为迅速的网站搜索服务。

不同的移动通信制式支持的带宽也是不同的，比如 LTE 就可以支持 1.4Mhz、3Mhz、5Mhz、10Mhz、15Mhz、20Mhz 这些不同的带宽。



## 窄带

通常窄带是以语音64Kbps作为参考值。

窄带物联网 NB-IoT 技术。

56kbps MODEM 拨号上网就是窄带，因为其理论信道带宽仅为 56kbps，换算成字节流量，理论传输能力就是 56k/8 = 7k/秒。而这个速度仅仅能满足少量文字信息的传输，对于大量数据的视频、音频、图象信息来说，却无力承载。



## 频段

Sub-1GHz 频带由于载波较长，可以传播较长的距离，这使其能够穿透墙壁。但是，距离越长，数据速率可能就需要越低，因为会出现数据丢失现象。

此外，您可以选择使用功率放大器 (PA)，通过将它们与适当的外部天线配对来延长应用的通信距离。



## Balun 巴伦

射频输出的是差分射频信号，后面就接了一个 balun，然后是天线，为什么要那个 balun？它对输出的信号功率有什么影响？

目的是为了发射单元的输出阻抗与天线阻抗匹配，这两者不匹配会产生驻波（输出信号没有经过天线发射出去而返回到了发射单元），影响输出功率，严重失配时有可能损坏发射单元。balun（巴伦）有两个作用，阻抗变换和非平衡-平衡转换。

现在很多小信号的无线电收发 IC 的 LNA 是差分输入的，甚至它的射频功放也是差分输出的，此时如果天线是单端的，则需要用 balun 来进行单端到差分（平衡不与不平衡）的转换，许多基带低频电路也用此来进行平衡与不平衡转化。

## LNA 低噪声放大器 Low Noise Amplifier

LNA 是低噪声放大器，主要用于接收电路设计中。因为接收电路中的信噪比通常是很低的，往往信号远小于噪声，通过放大器的时候，信号和噪声一起被放大的话非常不利于后续处理，这就要求放大器能够抑制噪声。

LNA 的作用是从天线获取极其微弱的不确定信号，这些信号通常是微伏数量级的信号或者低于-100 dBm，然后将该信号放大至一个更有用的水平，通常约为0.5 到1 V。具体来看，在 50 Ω 系统中10 μV 为-87 dBm，100 μV 等于-67 dBm。

![无线发送接收模块的内部构造](figures/无线发送接收模块的内部构造.jpg)

## PA 功率放大器 Power Amplifier

PA 是指能输出大功率信号的放大电路。

无线 PA 可能是指无线信号从基站发射出去的基站功率放大器。

PA（功放）主要功能是功率放大，以满足系统要求，最重要的指标就是输出功率大小，其次线性如何等等，一般用在发射机的最后一级。



## 50欧姆阻抗

50Ω 传输线，就是特性阻抗为 50Ω 同轴射频电缆。



为什么很多工程师用 50 Ohm PCB 传输线，有些时候这则成为 PCB 布线的默认设置。为什么不是 60 Ohm 或者 70 Ohm？

RF 系统选择 50 ohm 的原因：

- 在线宽固定的情况下，有三个主要因素影响 PCB 的阻抗。
  - 第一，到 PCB 传输线最近的电磁干扰层的影响正比于PCB传输线到最近的参考平面的距离，越小的距离就越小的辐射。
  - 第二，串扰也随传输线的厚度有则明显的变化，减少一半的传输线厚度将减少传输线串扰。
  - 第三，越小的距离产生越小的阻抗，这个有利于减少容性负载的影响。
- 同时我们也要考虑机械问题（制程问题）。
  - 如，在高密度多层板的高压合夹层空间下，70Ω 的传输线在现在微小印刷技术下很难被制造出来。
  - 在这种情况下，50Ω 的传输线允许用比 70Ω 更宽的线宽，从而使电路板存在可制造性。
- 功率容量，抗击穿电压和衰减之间的综合考虑。
- 机械美观上的考虑。

一般 RF IC 都是做好了 50 欧姆阻抗的，所以你只需保证走线为 50 欧姆就行了，不然阻抗失配会造成信号的大量反射。我们射频板用的都是特殊的板材，一般是罗杰斯的，板厚一般为 0.508，通过 ADS 可以计算出 50 欧姆的线宽。看你的板子估计用的不是罗杰斯板材，你自己计算费事，而且对板材参数了解得也不是太清楚，建议你告诉 PCB 厂家，指定哪些线做 50 欧姆匹配，厂家会帮你修改线宽的。



## SAW

SAW也有多种用途，最主要的是做滤波器和谐振震荡用。

- 做滤波器用时，由于它插入损耗有点大，使用时最好不要放在 LNA 前面。一定要放前面的话，最好在放大器作适当补偿，使整个电路的噪声系数改善些。
  - saw里面集成了滤波器。可以更好的改善接收信号的质量。
  - SAW 滤波器在抑制电子信息设备高次谐波、镜像信息、发射漏泄信号以及各类寄生杂波千扰等方面起到了良好的作用，可以实现所需任意精度的幅频特性和相频特性的滤波，这是其它滤波器所难以实现的。
- 作谐振震荡用时常用在要求不高的地方，因为它的频率稳定性远不及晶振。

任何接收机都是有工作带宽的。但是由于实际无线环境的复杂，常常会有带外的信号通过天线进入到接收线路中，如果没有SAW Filter的滤波作用，带外的信号就会对本接收机的工作造成干扰。

因为接收机前端的 LNA 工作带宽都是大于接收机实际工作带宽的，带外的信号进来也会被放大，在进行混频解调的过程中会导致接收机的误判决。另外，带外的信号也可能因为互调（intermodulation）作用对接收机的工作造成干扰。

在手机上，最明显的例子就是 Wi-Fi 发射对 GPS 造成的干扰。

因此，一般的接收机前端，都一定会有一个 SAW filter（ filter是一定有的，但不一定是声表面波的工艺）。



LNA 本身的非线性效应  所导致的 DC offset  就靠那颗外挂的 SAW 来滤除了 。 

如果他们自知 LNA 线性度不够，那当然就需要加 SAW。

可是若他们有自信，LNA 线性度够，不加 SAW 也 OK  那就可以拿掉。

# ■■■■■■■■■■■■■■■■■■■■■■

# 无线低功耗

无线做超低功耗，可以从以下 几个角度，进行优化。

## 从硬件角度

- 选择比较好的 MCU 和射频芯片。（例如，以前都用 CC1101，现在基本换成其他芯片了。MCU 一般选择 Cortex-M0+ 的超低功耗的 MCU）
- 如果需要上拉电阻，尽量先大一点的上位电阻。因为，例 3V 的电源，用 1M 的上拉电阻，就会产生 3 uA 的静态电流。
- 外部电路，例按键电路，我们会通过 2 个 GPIO 来实现按键。这样比较省电。当需要采样按键值时，用一个 GPIO 对按键电路供电。另一个 GPIO 用来采样按键是否按下。平时，则处于断电模式，不会耗电。便要注意，RC 电路的取值。
- 注：时间常数  RC 电路有个时间常数 T = R x C。根据公式可知，当 R x C 越大，时间常数越大，积分电路充放电就慢。反之，当 R x C 越小，时间常数越小，积分电路充放电就快。
- 尽量少用 I2C 通信接口。（ 2 个上拉电阻，静态电流，比较大）
- 时钟的选择也很重要。（一般用 MCU 内部 RC 作为时钟源，但精度不够，需要用高精度的时钟来较校准这个内部的 RC 时钟源。）

 

## 从 RF 无线射频角度

- 选择接收灵敏度高，RX 电流和 Tx 电流都比较小的 SoC 芯片或射频前端。
- RF 天线，匹配电路弄好。尽量以较小的 Tx 功率，实现相关的无线传输距离。
- 尽可能缩短 RSSI 的稳定时间。例如，更换 CC1101 成 SPIRIT1，则相应的 RSSI 的稳定时间，从 630uS（CC1101） 缩短到 300uS（SPIRIT1）。这样的话，可以减少 RF 芯片在 RX 状态的持续时间，从而降低功耗。（因为 RX 状态下的功耗也是比较大的。）

 

## 从软件角度

- 把整个中断向量表，在芯片初始化时，全部复制到 RAM 中，并重定向到 RAM。
- 同理，将经常调试的代码，从 Flash 拷贝到 RAM 中运行，以提高程序运行的速度，从而降低功耗（即尽快回到低功耗模式）。
  - 例如， IAR 下，可使用 “__ramfunc” 关键字。可以在同样的系统时钟，运行更快，进一步减少功耗，可以省个5%的功耗。（说白了，就是以空间换时间）
  - ramfunc 来声明将某个函数放到 RAM 中运行。该函数用 ramfunc 声明后，编译器将这段程序和其他需要初始化的变量，放在一个具有读/写属性的区域（SECTION）。系统启动时，自动和其他的需要初始化的变量，一起从 ROM 拷贝到 RAM。
  - 使用 __ramfunc 关键字的缺点，就是不能指定具体的 RAM 位置。而且在 ramfunc 的函数中调试不是 ramfunc 的函数会降低执行速度。
- While 循环里面代码、驱动，尽量不要调库，直接对芯片的寄存器操作。
- 减少一些函数的嵌套，减少出栈入栈所消耗的时间。尽可能地减少指令周期。

 

## 从无线协议角度

- 通过无线协议，将功耗转移到 panel 或基站端。
- 切换 SystemTick 时基：
  - 运行协议栈时，切到 10ms 中断一次。
  - 平时睡眠时，不需要运行协议栈时，切到 100ms 中断一次。
- 传感器和Panel主机之间的心跳包。Supervision 周期尽量拉长。例烟雾报警器，最长可以设置 1 小时的 Supervision 周期。
- 延长 Sensor 的唤醒时间。（但，同时，也会延长 Sensor 反应时间，即延迟）
- 使用 PSM 模式 （Power Saving Mode）
  - 待机功耗只有微安级别，这相当于部分关闭，降低了天线、射频、信令处理等功耗。
  - PSM 模式的优点是可以长时间睡眠，但缺点是无法及时应对终端接收（移动终端、MT）服务。
  - PSM 模式主要应用在远程抄表和一些对实时性要求不高的场景中。

# ■■■■■■■■■■■■■■■■■■■■■■

# 无线协议：比较

| 特性和规格 | 经典蓝牙     | 低功耗蓝牙                 | Zigbee             | Thread        | Wi-Fi        | 私有 Sub-1G        |
| ---------- | ------------ | -------------------------- | ------------------ | ------------- | ------------ | ------------------ |
| 通信范围   | 长达 100m    | 长达 200m 或 400m(支持 LR) | 长达 200m          | 长达 200m     | 长达 200m    | 长达 1600m         |
| 通讯频率   | 2.4 GHz      | 2.4 GHz                    | 2.4 GHz            | 2.4 GHz       | 2.4 GHz      | 低于 1GHz          |
| PHY 吞叶量 | 高达 3 Mbps  | 高达 2 Mbps                | 高达 250 kbps      | 高达 250 kbps | 高达 72 Mbps | 500 kbps           |
| 网络类型   | 点对点、星型 | 点对点、星型、广播         | 网状               | 网状          | 点对点、星型 | 点对点、星型、网状 |
| 网络规模   | 8            | 30                         | 500+               | 350+          | 250          | 1000+              |
| 电池类型   | 单节 AA 电池 | 纽扣电池                   | 纽扣电池和能量收集 | 纽扣电池      | 双节 AA 电池 | 纽扣电池           |
|            |              |                            |                    |               |              |                    |



# 无线协议：2.4 GHz

## Wi-Fi

### Wi-Fi 的优点

- 网络类型：
  - Wi-Fi 通常是星型连接，但也支持网状网络功能。
- 无线稳健性：
  - Wi-Fi 在 2.4GHz 和 5GHz 两个频谱上运行，这两个频谱在全球范围内都是开放的无线频谱。
  - 而且， Wi-Fi 使用多个频率信道来避免冲突。
- 安全性：
  - Wi-Fi 拥有一个活跃的生态系统，它不断地发展该技术的安全性，使其保持最新状态和稳健，以抵御黑客的攻击。
  -  Wi-Fi 数据在传输之前可以通过 WPA 加密技术进行加密。
  -  Wi-Fi 还具有多层安全性，因为它具有本地 IP（如 TLS）。 
- 吞吐量：
  - Wi-Fi 旨在用于支持高数据速率。
  - 随着新标准的定义，它现在可通过多输入多输出 (MIMO) 实施支持超过 1Gbps 的传输速率。
- 功耗：
  - Wi-Fi 也是同等数据传输位数情况下最省电的方式。
  - 该协议还非常灵活，允许电池应用以非常低的平均功率持续连接到网络。

- 目标应用：
  - 它通常用于消费类、工业和企业应用。
  - Wi-Fi 可用于笔记本电脑、智能手机、恒温器控制器和许多其他需要连接到互联网的应用。 
  - Wi-Fi 是应用最广泛的无线通信标准之一，用于在设备与互联网之间进行高吞吐量通信。

### Wi-Fi 的潜在缺点

- 功耗。Wi-Fi 峰值功耗较高，因此需要较大的电池，如 AA 型号的电池。
- 距离。Wi-Fi 旨在用于本地化网络。在 5 GHz 的频率下，相应频谱很快就会衰减或被屏蔽，因此无法穿过墙壁。

## 经典蓝牙

### 经典蓝牙的优点

- 网络类型：经典蓝牙旨在用于短距离应用，支持点对点 (P2P) 和星型网络拓扑等网络类型。
- 吞吐量：经典蓝牙旨在用于高数据吞吐量应用（如音频流传输），数据速率高达 3Mbps。
- 示例应用：通过无线耳机、扬声器和条形音箱进行音频流传输。

### 经典蓝牙的潜在缺点

经典蓝牙未针对低功耗应用进行优化。



## BLE 低功耗蓝牙

### 低功耗蓝牙的优点

- 网络类型
  - 低功耗蓝牙旨在用于短距离应用，支持点对点 (P2P)、星型和广播设备角色。
  - 低功耗蓝牙可用 于运行状况监视器、个人电子产品和资产跟踪器等多种应用。
  - 蓝牙是一种出色的无线技术媒介，它可以在 两个设备（如智能汽车接入）之间快速建立连接并交换数据。
- 功耗
  - 低功耗蓝牙旨在用于超低功耗无线通信，只需一节纽扣电池即可运行数年。
  - 该协议旨在实现轻 量级应用，且可灵活地调整各种通信间隔参数，例如以 1 秒间隔进行广播。
- 吞吐量
  -  低功耗蓝牙 BT4 及更高版本的标准数据速率为1  Mbps，这对于大多数类型的通信来说已经足够 了。
  - 但是，低功耗蓝牙 BT5 现在还支持高达 2 Mbps 的速率，可实现更快的数据传输。
- 无线稳健性
  - 低功耗蓝牙使用 2.4 GHz 无线频带，会有其他无线技术（如 Wi-Fi、 Zigbee 和 Thread） 与其共用该频带。
  - 为了在这个拥挤的频带内减少冲突，蓝牙会在通信前使用跳频找到一个开放的信道。
- 安全性
- 示例应用
  - 无线键盘、心率监视器、血压监视器、智能汽车接入等等。
  - 低功耗蓝牙是应用最为广泛的 无线技术，因为它普遍应用于每一款智能手机或平板电脑中。

### 低功耗蓝牙的潜在缺点

- 距离
  - 蓝牙不适用于需要远距离连接的应用。
- 蓝牙需要一个网关网桥来连接到 IP 网络。



## Zigbee

### Zigbee 的优点

- 网络类型 
  - Zigbee 技术是一种基于网状网络的协议，它允许网络根据应用的需要而扩增。
  - 该技术支持自生自愈的网状网络。
  - 总共有四种不同的 Zigbee 角色：协调器、路由器、终端设备和绿色电源设备。
  -  Zigbee 主要用于楼宇和家庭自动化。
- 功耗
  - Zigbee 是一款低功耗无线通信技术，可在终端应用中实现极长的电池寿命。
  - 为了实现这种等级的功耗， 终端设备会周期性地唤醒以发送数据，然后尽快重新回到低功耗模式。 
  - Zigbee 绿色电源设备甚至可以实现无电池应用，例如使用太阳能电池板收集能量。
- 无线稳健性 
  - Zigbee 是基于 IEEE 802.15.4 的无线堆栈（作为物理层和 MAC 层）。
  -  Zigbee 应用能够选择一个特定的信道来与多达 16 个信道通信。 
  - Zigbee 是一种自愈型技术，可以识别网络中断开的 节点并根据需要重新路由，以保护相应网络。
- 距离
  - Zigbee 应用的典型距离是长达 200m 的视线范围（单跳）。
  - 但是，Zigbee 可以通过其网状网络功能实现远距离通信，方法是在网络中以菊链式方式连接多个 Zigbee 路由器。
- 安全性
- 目标应用
  - Zigbee 网络可用于各种家庭自动化控件，如无线照明开关、恒温器等等。 
  - Zigbee 认证可保证与来自其他供应商的 Zigbee 认证产品的互操作性。

### Zigbee 的潜在缺点

- 网络类型
  - Zigbee 无法提供轻松连接到云的方法。连接到 IP 网络需要一个网关和地址转换层。
- 吞吐量
  - Zigbee 不适用于高数据速率传输。
  - 该技术旨在用于低数据速率应用，最大吞吐量为  250 kbps。



## Thread

### Thread 的优点

- 网络类型
  - Thread 旨在用于在基于 IP 的网络中使用网状拓扑的互联家居应用。
  - 它主要设计用于楼宇自动化，以控制照明、恒温器和其他产品。 
  - Thread 可自生自愈，这意味着它会自动升级或降级节点，以确保 网络中没有单点故障。
  - 此外， Thread 可以与任何 IPv6 网关协同工作，因此可以轻松地在网络中添加新设备。
- 功耗 
  - Thread 旨在用于在低功耗传感应用中运行，并将传感器连接到 IPv6 网络。 
  - Thread 终端设备可以长时间睡眠，从而延长电池寿命。
- 距离
  - Thread 的典型距离是长达 200m 的视线范围（单跳）。 
  - Thread 是一种网状网络，最多可通过 32 跳来延长距离。
- 安全性
  - 默认情况下，使用 AES-128 来保护设备间通信。
  - 调试则使用支持 ECJ-PAKE 的标准 DTLS。
- 目标应用 
  - Thread 网络可用于各种家庭自动化设备，如灯泡、电子锁等等。
  -  Thread 还被设计为可通过任何经Thread 认证的设备进行控制。
  - 它可以轻松与任何现有的应用框架集成。

###  Thread 的潜在缺点

- 吞吐量
  - 基于 IPv6 的网络有可能会出现高开销。
  - 因此，Thread 250kbps 的吞吐量可能不足以满足现有的 IPv6 部署。
- 应用不可知性
  - Thread 没有规定一个可互操作的应用框架；
  - 虽然 Thread 证明了网络互操作性，但应用框架互操作性无法得到保证。

## 私有 2.4 GHz

### 专有 2.4GHz 的优点

- 网络类型
  - 通过专有 2.4GHz 网络，您可以灵活地设计点对点、网状或星型网络配置，从而灵活地定制自己的无线应用层协议。 
  - 2.4GHz 的运行频带在世界各地均无需许可，这意味着您可以以较低的成本部署应用。
- 功耗 
  - 专有解决方案可实现最佳的潜在功率优化，因为它在自定义数据传输的计时和持续时间方面不受限制。
- 吞吐量
  - 它可以实现比大多数无线标准更高的有效数据传输速率，因为您可以优化通常与无线协议相关的通信开销。
- 目标应用 | 非常适合定制无线协议应用，且与传统 2.4GHz 无线协议应用具有互操作性。

### 专有 2.4GHz 的潜在缺点

- 标准
  - 选择采用专有 2.4GHz 是为了支持与现有标准不同的定制协议。
  - 当在不同对等点之间通信时，必须定义应用层协议。专有 2.4GHz 协议无法与使用任何其他无线标准的设备进行互操作。
- 距离 
  - 2.4GHz 网络通常并不提供最远距离（如需远距离专有网络，则需要采用“专有低于 1GHz”或采用 mesh 网状网络）。
  - 但是，您可以选择带有功率放大器 (PA) 的无线设备，通过将它们与适当的外部天线配对来延长应用的通信距离。（但会提高功耗。）



# ■■■■■■■■■■■■■■■■■■■■■■

# 无线安全

万物互联，安全为先。

当物联网中的节点数目达到一个惊人的量级的时候，安全问题必将成为一个关键环节。要解决安全问题，必须从多方面综合考虑，比如添加安全认证芯片，引入防拆解技术，增加安全启动，进行通信加密等。



![XXX](figures/XXX.jpg)



