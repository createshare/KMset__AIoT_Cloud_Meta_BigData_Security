# RTOS 嵌入式实时操作系统



## OS 操作系统 Operating System

操作系统按硬件范畴的表现形式分：芯片级嵌入（含程序或算法的处理器）、模块级嵌入（系统中的某个核心模块）系统级嵌入。

操作系统按软件范畴实时性要求分：非实时系统、软实时系统、硬实时系统。

![OS 操作系统的基本功能](C:\Users\blues\Desktop\figures\OS 操作系统的基本功能.jpg)

## 实时操作系统（RTOS）

- 实时操作系统（RTOS）是指当外界事件或数据产生时，能够接受并以足够快的速度予以处理，其处理的结果又能在规定的时间之内来控制生产过程或对处理系 统作出快速响应，并控制所有实时任务协调一致运行的操作系统。因而，提供及时响应和高可靠性是其主要特点。
- 实时操作系统是保证在一定时间限制内完成特定功能的操作系统。

- 实时操作系统有硬实时和软实时之分
  - 硬实时要求 在规定的时间内必须完成操作，这是在操作系统设计时保证的；在“硬”实时操作系统中，如果不能在允许时间内完成使物体可达的计算，操作系统将因错误结束。
  - 软实时则只要按照任务的优先级，尽可能快地完成操作即可。在“软”实时操作系统中，生产线仍然 能继续工作，但产品的输出会因产品不能在允许时间内到达而减慢，这使机器人有短暂的不生产现象。
- 我们通常使用的操作系统在经过一定改变之后就可以变成实时操作系统。



### 实时操作系统的特征

- 多任务
- 有线程优先级
- 多种中断级别

- 时间约束性
  实时系统的任务具有一定的时间约束，即截止时间，超出截止时间将变成错误的结果；
- 可预测性
  指的是能够对实时任务的执行时间进行判断，以确定是否能够满足任务的时间约束性要求；
- 可靠性
  大多数实时系统要求有较高的可靠性，特别是硬实时系统，它基本上是一个功用性系统；
- 与外部环境的交互性
  实时系统通常运行在一定的环境下，等待外界事件触发而后进行处理响应；

### 硬实时系统与软实时系统

- 外在的区别在于功用性上:
  硬实时系统在给定时间t之后，马上变为零值。
  软实时系统随着给定时间t的推移，效用迅速的走向零值。
- 内在的区别在于，软实时允许偶尔计算过程超出时间限定。
- 采用实时操作系统的意义就在于能够及时处理各种突发的事件，即处理各种中断，因而衡量嵌入式实时操作系统的最主要、最具有代表性的性能指标参数无疑应该是中断响应时间了。中断响应时间通常被定义为：
  - 中断响应时间=中断延迟时间+保存CPU状态的时间+该内核的ISR进入函数的执行时间
  - 中断延迟时间=MAX(关中断的最长时间，最长指令时间) + 开始执行ISR的第一条指令的时间

### 硬实时系统

- 硬实时系统指系统要在最坏情况（负载最重）下确保服务时间，即对于事件的响应时间的截止期限是无论如何都必须满足。硬实时要求在规定的时间内必须完成操作，这是在操作系统设计时保证的；
- 在“硬”实时操作系统中，如果不能在允许时间内完成使物体可达的计算，操作系统将因错误结束。

- 硬实时系统的代表产品：VxWorks。以性能稳定而著称。
- 对于一些涉及到人身安全或者非常重要的任务，必须使用硬实时操作系统，更多用于对实时性要求更高的工业制造领域。比如汽车安全气囊的控制，晚一秒钟打开可能就会丧生一条人命，这种场合必须使用硬实时系统。

### 软实时系统

- 软实时系统是从统计的角度，任何一个任务都能够有一个预期的处理时间，但任务一旦超过截止期限，也并不会带来致命的错误。软实时则没有那么严，只要按照任务的优先级，尽可能快地完成操作即可。
- 在“软”实时操作系统中，生产线仍然能继续工作，但产品的输出会因产品不能在允许时间内到达而减慢，这使机器人有短暂的不生产现象。
- 软实时系统的代表产品：各种实时 Linux。当然，也有不少在 Linux 基础上做了实时性的改进，例如 RTLinux等。
- 对于 IPTV 数字电视机顶盒，需要实时的解码视频流，所以需要使用实时操作系统。但即使丢失了几个视频帧，在短时间内视频可能会有一些不流畅，但马上就会恢复，不会造成什么严重的后果。这种消费类电子产品，适合使用软实时操作系统。

## 裸机系统 与 多线程系统

### 裸机系统

裸机系统通常分成轮询系统和前后台系统：

- 轮询系统
  - 轮询系统即是在裸机编程的时候，先初始化好相关的硬件，然后让主程序在一个死循环里面不断循环，顺序地做各种事情 。   
  - 轮询系统只适合顺序执行的功能代码，当有外部事件驱动时，实时性就会降低。  
- 前后台系统
  - 前后台系统是在轮询系统的基础上加入了中断。  
  - 外部事件的响应在中断里面完成，事件的处理还是回到轮询系统中完成。  
  - 中断在这里我们称为前台， main 函数里面的无限循环我们称为后台。 
  - 在中断服务程序里面标记事件，如果事件要处理的事情很简短，则可在中断服务程序里面处理，如果事件要处理的事情比较多，则返回到后台程序里面处理。  
  - 相比轮询系统，前后台系统确保了事件不会丢失，再加上中断具有可嵌套的功能，这可以大大的提高程序的实时响应能力。  

### 多线程系统  

- 相比前后台系统，多线程系统的事件响应也是在中断中完成的，但是事件的处理是在线程中完成的。 
- 在多线程系统中，根据程序的功能，我们把这个程序主体分割成一个个独立的，无限循环且不能返回的小程序，这个小程序我们
  称之为线程。  
- 每个线程都是独立的，互不干扰的，且具备自身的优先级，它由操作系统调度管理。  
- 在多线程系统中，线程跟中断一样，也具有优先级，优先级高的线程会被优先执行。
- 当一个紧急的事件在中断被标记之后，如果事件对应的线程的优先级足够高，就会立马得到响应。
- 相比前后台系统，多线程系统的实时性又被提高了。   
- 加入操作系统后，我们在编程的时候不需要精心地去设计程序的执行流，不用担心每个功能模块之间是否存在干扰。
- 加入了操作系统，我们的编程反而变得简单了。  



## RTOS 和 Linux

- RTOS 是实时操作系统，实时操作系统是多任务、有线程优先级、多种中断级别、在规定时间内可以对处理系统，快速做出响应的操作系统；

- 而 Linux 是分时操作系统。而分时操作系统是一台计算机，可以同时拥有多个用户的操作系统。

- Linux是时分系统，不过可以通过配置内核改成实时系统。

  

