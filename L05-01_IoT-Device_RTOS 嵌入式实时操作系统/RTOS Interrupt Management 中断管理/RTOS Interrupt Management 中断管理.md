# RTOS Interrupt Management 中断管理

## 什么是异常

- 异常是指任何打断处理器正常执行，并且迫使处理器进入一个由有特权的特殊指令执行的事件。   
- 异常是导致处理器脱离正常运行转向执行特殊代码的任何事件，如果不及时进行处理，轻则系统出错，重则会导致系统毁灭性地瘫痪。  
- 所以正确地处理异常，避免错误的发生是提高软件鲁棒性（稳定性）非常重要的一环，对于实时系统更是如此。  
- 异常通常可以分成两类：同步异常和异步异常。  
  - 同步异常
    - 由内部事件（像处理器指令运行产生的事件）引起的异常称为同步异常
    - 同步异常事件是由于执行某些指令而从处理器内部产生的。  
    - 同步异常触发后，系统必须立刻进行处理而不能够依然执行原有的程序指令步骤。 
    - 例如，造成被零除的算术运算引发一个异常。
    - 例如，必须从内存的偶数地址进行读和写操作。但是从一个奇数内存地址的读或写操作将引起存储器存取一个错误事件并引起一个异常，（称为校准异常） 。  
  - 异步异常
    - 异步异常主要是指由于外部异常源产生的异常， 是一个由外部硬件装置产生的事件引起的异步异常。  
    - 异步异常事件的来源是外部硬件装置。
    - 异步异常则可以延缓处理甚至是忽略，例如按键中断异常，虽然中断异常触发了，但是系统可以忽略它继续运行（同样也忽略了相应的按键事件）。  
    - 例如，按下设备某个按钮产生的事件。     



## 什么是中断

- 中断， 中断属于**异步异常**。  
- 当 CPU 正在处理内部数据时，外界发生了紧急情况，要求 CPU 暂停当前的工作转去处理这个 异步事件。处理完毕后，再回到原来被中断的地址，继续原来的工作，这样的过程称为**中断**。  
- 实现这一功能的系统称为 **中断系统**，申请 CPU 中断的请求源称为 **中断源**。  
- 中断号：每个中断请求信号都会有特定的标志，使得计算机能够判断是哪个设备提出的中断请求，这个标志就是中断号。  
- 中断请求：“紧急事件”需向 CPU 提出申请，要求 CPU 暂停当前执行的线程，转而处理该“紧急事件”，这一申请过程称为中断请求。  
- 中断优先级：为使系统能够及时响应并处理所有中断，系统根据中断时间的重要性和紧迫程度，将中断源分为若干个级别，称作中断优先级。  
- 中断处理程序：当外设产生中断请求后， CPU 暂停当前的线程，转而响应中断申请，即执行中断处理程序。  
- 中断触发：中断源发出并送给 CPU 控制信号，将中断触发器置“1”，表明该中断源产生了中断，要求 CPU 去响应该中断， CPU 暂停当前线程，执行相应的中断处理程序。  
- 中断触发类型：外部中断申请通过一个物理信号发送到 NVIC，可以是电平触发或边沿触发。  
- 中断向量：中断服务程序的入口地址。  
- 中断向量表：存储中断向量的存储区，中断向量与中断号对应，中断向量在中断向量表中按照中断号顺序存储。  
- 临界段：代码的临界段也称为临界区，一旦这部分代码开始执行，则不允许任何中断打断。为确保临界段代码的执行不被中断，在进入临界段之前须关中断，而临界段代码执行完毕后，要立即开中断。  



## 中断实时性相关概念

- 关中断时间

  - 指的是程序中有一些临界段代码，需要关闭中断才能安全访问那么访问这段代码前关总中断，访问完后打开总中断，在这个时间内，系统是无法响应外部任何中断的。

- 最大关中断时间

  - 指的是这么多个临界段代码的关中断时间中最大的那个，即这个时间就代表了最差最坏情况下中断的关闭时间了，因为实时操作系统中很多时间问题都是基于最差情况下考虑的。

- 中断响应时间

  - 接收到此中断到此中断对应的中断服务函数的第一条语句执行所经历的时间。其计算公式是：


```
中断响应时间 ＝ 最大关中断时间 + 保护 CPU 内部寄存器的时间 + 进入中断服务函数的执行时间（会根据中断向量表找到对应的终端服务函数地址即入口）+ 开始执行中断服务例程 (ISR) 的第一条指令时间。
```

- 中断恢复时间

  - 指从中断响应成功（即开始执行中断服务例程 ( ISR ) 的第一条指令时刻）一直到中断服务函数执行完毕再到切换回被中断的任务的接着一条代码执行所经历的时间。其计算公式是：

```
中断恢复时间 = 中断服务函数执行所需时间（这样说不太准确，意思就是基本执行完所需时间，不包括退出中断服务函数前会调用一下 OSIntExit() 函数）+ OSIntExit()（这个函数在中断服务函数末尾调用的，退出中断前来发生任务切换的）+ OSIntCtxSw()（真正发生任务切换的函数，会进行寄存器数据弹出等操作）。
```

- 任何使用了操作系统的中断响应都不会比裸机快。（因为临界段虽然通过开关中断保护了关键代码的执行不被打断， 但会影响系统的实时）

# ■■■■■■■■■■■■■■■■■■■■■

# ARM Cortex-M 处理器  

- 不同于老的经典 ARM 处理器（例如： ARM7, ARM9）， ARM Cortex-M 处理器有一个非常不同的架构， Cortex-M 是一个家族系列，其中包括 Cortex M0/M3/M4/M7 多个不同型号。
- 每个型号之间会有些区别，例如 Cortex-M4 比 Cortex-M3 多了浮点计算功能等，但它们的编程模型基本是一致的。



## 寄存器简介  

Cortex-M 系列 CPU 的寄存器组里有 R0~R15 共 16 个通用寄存器组和若干特殊功能寄存器：

- R0~R15 共 16 个通用寄存器组
  - **R0-R12**：通用寄存器，都是32 位通用寄存器，用于数据操作。
    - 但是注意：绝大多数 16 位 Thumb 指令只能访问 R0‐R7，
    - 而 32 位 Thumb‐2 指令可以访问所有寄存器
  - **R13** 作为**堆栈指针寄存器** (Stack Pointer， SP)  
    - SP 有两个，任一时刻只能使用其中的一个，这也就是所谓的 “banked” 寄存器。
    - 主堆栈指针（MSP）：复位后缺省使用的堆栈指针，用于操作系统内核以及异常处理例程（包括中断服务例程）
    - 进程堆栈指针（PSP）：由用户的应用程序代码使用。
  - **R14** 作为**连接寄存器 (Link Register，LR)**，用于在调用子程序时，存储返回地址。即，当呼叫一个子程序时，由R14 存储返回地址。
  - **R15** 作为**程序计数寄存器**，指向当前的程序地址。如果修改它的值，就能改变程序的执行流。

![Cortex-M 系列 CPU 的寄存器组](figures/Cortex-M 系列 CPU 的寄存器组.png)

- 特殊功能寄存器，例如，Cortex‐M3 还在内核水平上搭载了若干特殊功能寄存器，包括：

  - **程序状态字寄存器组（PSRs）**：保存算术与逻辑标志，例如负数标志，零结果标志，溢出标志等等。
  - **中断屏蔽寄存器组（PRIMASK, FAULTMASK, BASEPRI）**：控制 Cortex-M 的中断除能。
  - **控制寄存器（CONTROL）**：用来定义特权级别和当前使用哪个堆栈指针。
  - 可以通过 MSR/MRS 指令来访问特殊功能寄存器。例如，

  ```assembly
  MRS R0, CONTROL ; 读取 CONTROL 到 R0 中
  MSR CONTROL, R0 ; 写入 R0 到 CONTROL 寄存器中
  ```

- FPU 浮点计算功能

  - 如果是具有浮点单元的 Cortex-M4 或者 Cortex-M7，控制寄存器也用来指示浮点单元当前是否在使用
  - 浮点单元包含了 32 个浮点通用寄存器 S0\~S31 和特殊 FPSCR 寄存器（Floating point status and control register）。



## 操作模式和特权级别  

- Cortex-M 引入了两种运行模式，**hander模式**和**线程模式**。根据操作权限的不同，又分为**特权级**和**用户级**。

  - 为了提供一种存储器访问的保护机制，使得普通的用户程序代码不能意外地，甚至是恶意地执行涉及到要害的操作，处理器支持**两种特权级（特权级hander模式、特权级线程模式）**
  - 如果进入异常或中断处理则进入异常处理（handler）模式，其他情况则为线程模式。  

  ![Cortex-M 操作模式和特权级别](figures/Cortex-M 操作模式和特权级别.png)

- Cortex-M 有两个运行级别，分别为特权级和用户级
  - 线程模式可以工作在特权级或者用户级
  - 而异常处理（handler）模式总工作在特权级，可通过 CONTROL 特殊寄存器控制

- Cortex-M 的堆栈寄存器 SP 对应两个物理寄存器 MSP (主堆栈) 和 PSP (进程堆栈)
  - 线程模式可以选择使用 MSP 或 PSP 作为堆栈
  - 处理模式总是使用 MSP 作为堆栈
  - 同样通过 CONTROL 特殊寄存器控制。(控制寄存器用来定义特权级别和当前使用哪个堆栈指针。)
- 复位后，Cortex-M 默认进入线程模式、特权级、使用 MSP 堆栈。



## 中断相关的硬件  

中断处理与 CPU 架构密切相关。例如，ARM Cortex-M 的 CPU 架构。

与中断相关的硬件可以划分为三类： 外设、中断控制器、 CPU 本身。  

- 外设： 当外设需要请求 CPU 时，产生一个中断信号，该信号连接至中断控制器。  
- 中断控制器：中断控制器是 CPU 众多外设中的一个。
  - 它一方面接收其它外设中断信号的输入
  - 另一方面，它会发出中断信号给 CPU。
  - 可以通过对中断控制器编程实现对中断源的优先级、触发方式、打开和关闭源等设置操作。
  -  在 Cortex-M 系列控制器中常用的中断控制器是 NVIC（内嵌向量中断控制器 Nested Vectored Interrupt Controller） 。
  - NVIC 最多支持 240 个中断，每个中断最多 256 个优先级。  
- CPU： CPU 会响应中断源的请求，中断当前正在执行的线程，转而执行中断处理程序。
  

## 嵌套向量中断控制器 NVIC

- Cortex-M 中断控制器名为 NVIC（嵌套向量中断控制器），支持中断嵌套功能。

- 当一个中断触发并且系统进行响应时，处理器硬件会将当前运行位置的上下文寄存器自动压入**中断栈**中，这部分的寄存器包括 **PSR、PC、LR、R12、R3-R0 寄存器**。

- 当系统正在服务一个中断时，如果有一个更高优先级的中断触发，那么处理器同样会打断当前运行的中断服务程序，然后把这个中断服务程序上下文的 PSR、PC、LR、R12、R3-R0 寄存器自动保存到中断栈中。

  ![Cortex-M 嵌套向量中断控制器](figures/Cortex-M 嵌套向量中断控制器.png)

