# RTOS Low Power 低功耗

- 随着物联网 (IoT) 的兴起，产品对功耗的需求越来越强烈。作为数据采集的传感器节点通常需要在电池供电时长期工作，而作为联网的 SOC 也需要有快速的响应功能和较低的功耗。  
- 高性能与有限的电池能量在嵌入式系统中矛盾最为突出。

- 硬件低功耗设计与软件低功耗管理的联合应用成为解决矛盾的有效手段。  

- 现在的各种 MCU 都或多或少的在低功耗方面提供了管理接口  
  - 对主控时钟频率的调整  
  - 工作电压的改变  
  - 总线频率的调整甚至关闭  
  - 外围设备工作时钟的关闭等  



## 低功耗管理分为三个类别  

- 处理器电源管理主要实现方式：对 CPU 频率的动态管理，以及系统空闲时对工作模式的调整。
- 设备电源管理主要实现方式：关闭个别闲置设备
- 系统平台电源管理主要实现方式：针对特定系统平台的非常见设备具体定制。  



# ■■■■■■■■■■■■■■■■■■■■■■■

# RTOS 实现低功耗

- MCU 实现低功耗本质而言便是停止 MCU 工作，通过中断的方式重新唤醒 MCU，这些中断可以包括外部 IO 中断，UART 接收中断，定时器中断等等。
- 但是在 uCOS、FreeRTOS 之类的操作系统，实现这一模式就有点麻烦，最大的问题是任务切换是无法控制的，经常出现唤醒之后程序跑飞的情况。
- 利用操作系统进入和退出低功耗模式，需要熟悉嵌入式操作系统的空任务和系统滴答时钟中断。
- 结合嵌入式操作系统，**可以在空任务或者空任务钩子函数中进入低功耗模式，在系统滴答时钟中断服务函数中重新回到正常工作模式。**
- 要把休眠的代码段放在低优先级任务中，不一定是系统自带的空闲任务，也可以是用户自定义的最低优先级的任务。



## 方法 1：空任务或者空任务钩子函数中进入低功耗模式

- 因为系统要响应系统节拍中断事件，因此使用这种方法会周期性的退出、再进入低功耗状态。
- 如果系统节拍中断频率过快，则大部分电能和CPU时间会消耗在进入和退出低功耗状态上。
- 空任务优先级最低且一直保持就绪状态，空任务可以用于统计 CPU 使用率，或者让 MCU 进入低功耗状态。如果不想修改空任务，还可以通过空任务的钩子函数插入实现低功耗的代码。
- 以 FreeRTOS 为例
  - 空闲钩子设置低功耗时，需要在 FreeRTOSConfig.h 中，将宏 configUSE_IDLE_HOOK 置为 1，然后自己实现固定接口：void vApplicationIdleHook(void );
  - 同时， 这个钩子函数不可以调用会引起空闲任务阻塞的API函数（例如：vTaskDelay()、带有阻塞时间的队列和信号量函数），在钩子函数内部使用协程是被允许的。
  - 在空闲任务钩子函数中设置微处理器进入低功耗模式来达到省电的目的。


