# Face Recognition 人脸识别



# 人脸识别 流程

完整的人脸识别，至少需要跑3个模型：（1）人脸检测Detect ， （2）人脸属性 ， （3）人脸比对

| 步骤                                      | 描述                                                         | 需要的模型         | Note                                                 |
| ----------------------------------------- | ------------------------------------------------------------ | ------------------ | ---------------------------------------------------- |
| Step_01  输入照片  对图像进行预处理       | 例：  缩放/修改图片尺寸大小，到模型要求的大小。  例：FaceNet （160*160的图像） |                    |                                                      |
| Step_02  人脸检测                         | 从图片中准确定位到人脸。扣出 人脸。  返回：高精度的人脸框坐标及人脸特征点坐标。  方法1：MTCNN  方法2：OpenCV  其他方法：Dilb，OpenFace等 | Detect 模型        |                                                      |
| Step_03  人脸矫正（对齐）                 | 检测到的人脸，可能角度不是很正，需要使其对齐。               | 需要单独的模型么？ |                                                      |
| Step_04  对矫正后的人脸进行特征提取       |                                                              |                    |                                                      |
| Step_05‑A   人脸识别  (方法A)             | 输入两张人脸，判定是否属于同一人。  对两张人脸图像的特征向量进行对比，计算相似度。     方法1：FaceNet模型：比较特征向量间的欧式距离，判断是否为同一人，例如当特征距离小于1的时候认为是同一个人，特征距离大于1的时候认为是不同人。 | 人脸识别模型       | （1）A和B 方法，  识别的时间，识别的方法，有区别么？ |
| Step_05_B  人脸识别  (方法B)              | 输入一张人脸，判断其属于人脸数据库全部记录中具体哪一人     当Panel里面，注册的用户多了之后，对识别的时间，影响大么？ | 人脸识别模型       | （2）人脸识别的数据集，需要我们自己训练么？          |
| Step_06  人脸属性                         | 性别，人脸的角度，是否带眼镜等                               | 人脸属性模型       |                                                      |
| Step_07  返回结果                         | 1. 匹配度（Distance）  2.人脸属性（性别，角度，是否带眼镜等） |                    |                                                      |
| Step_08  评估模型和数据集的准备性（精度） |                                                              |                    |                                                      |



# 人脸检测

## MTCNN 人脸检测

**MTCNN全称:** Multi-task convolutional neural network（多任务卷积神经网络），是一种Multi-task的人脸检测框架，将人脸区域检测与人脸关键点检测放在了一起，基于cascade框架。

**MTCNN** 可实现以下任务：

- 人脸检测与人脸关键点检测, 由三个级联的轻量级 CNN 完成：PNet，RNet和Onet。
- 图像数据先后经这三个网络的处理，最终输出人脸检测和关键点检测结果。
- 算法从三个方面对CNN检测器进行训练：人脸分类（人脸、非人脸的分类）、边界框回归、地标定位（关键点定位）。

### MTCNN人脸检测的训练数据

MTCNN人脸检测的训练数据可以从http://mmlab.ie.cuhk.edu.hk/projects/WIDERFace/地址下载。该数据集有32,203张图片，共有93,703张脸被标记

### MTCNN人脸关键点检测的训练数据

人脸关键点检测的训练数据可从http://mmlab.ie.cuhk.edu.hk/archive/CNN_FacePoint.htm地址下载。该数据集包含5,590张 LFW数据集的图片和7,876张从网站下载的图片。



### MTCNN人脸检测与对齐模型

执行过程如下所示：

1. 首先读入要检测的图片：image = cv2.imread(imagepath)
2. 加载训练好的模型参数，构建检测对象：detector = MtcnnDetector
3. 执行推理操作：all_boxes,landmarks = detector.detect_face(image)
4. 绘制目标框：cv2.rectangle(image, box,(0,0,255))



### MTCNN的主要步骤

Stage1：首先将图像进行不同尺度的变换，构建图像金字塔，以适应不同大小的人脸的进行检测。

Stage2：P-Net，全称为Proposal Network，其基本的构造是一个全连接网络。对上一步构建完成的图像金字塔，通过一个FCN进行初步特征提取与标定边框，并进行Bounding-Box Regression调整窗口与NMS进行大部分窗口的过滤。

 Stage3：R-Net，全称为Refine Network，其基本的构造是一个卷积神经网络，相对于第一层的P-Net来说，增加了一个全连接层，因此对于输入数据的筛选会更加严格。在图片经过P-Net后，会留下许多预测窗口，我们将所有的预测窗口送入R-Net，这个网络会滤除大量效果比较差的候选框，最后对选定的候选框进行Bounding-Box Regression和NMS进一步优化预测结果。

Stage4：O-Net，全称为Output Network，基本结构是一个较为复杂的卷积神经网络，相对于R-Net来说多了一个卷积层。O-Net的效果与R-Net的区别在于这一层结构会通过更多的监督来识别面部的区域，而且会对人的面部特征点进行回归，最终输出五个人脸面部特征点。

#### P-Net 

**输入**：待检测的图像。

**输出**：m*n（最终特征图的尺度）个box坐标回归值以及对应的是否为人脸的得分。经过进一步的计算，得到可能为人脸的box集合。

**中间过程简述：**将原图重采样（resample），得到一系列尺寸的待检测图。对于每一张待检测图，输入到PNet，会输出一系列box，去掉那些得分（score）不达标的box，并用非极大值抑制（nms）再去掉一部分box。对于所有尺寸的待测图，都得到类似的box集合。将所有box集合合并，再用nms去除一部分box，余下的就是第一阶段最终的输出。

#### R-Net

**输入：**第一阶段生成的box，在原图中截取对应的区域，将所有截取得到的图像合 并到一个四维矩阵中，作为RNet的输入。

**输出：**对于输入的每个box，输出其对应的坐标回归值以及对应的是否为人脸的得 分。将得分不达标的box去掉，得到第二阶段的box集合。也就是说，第二 阶段是在第一阶段的基础上对box实现进一步分筛选，同时也会以通过回归 将box坐标进行更新，使得其精度更高。

#### O-Net 人脸检测阶段

**输入**：类似于RNet，但以第二阶段的输出为输入。

**输出**：类似于RNet。

#### O-Ne脸关键点检测阶段

**输入**：3.1中最终得到的人脸图像。

**输出**：N*（2*5）个坐标值。其中N是人脸的数目，每个人脸检测5个关键点。







# 人脸识别

## FaceNet 人脸识别模型（开源库）

FaceNet 是基于 TensorFlow 的人脸识别开源库。

### FaceNet的理论思想

FaceNet的理论思想：是把人脸图像映射到一个多维空间，通过空间距离表示人脸的相似度。同一个人脸图像的空间距离比较小，不同人脸图像的空间距离比较大，这样通过人脸图像的空间映射就可以实现人脸识别。即，通过 CNN 将人脸映射到欧式空间的特征向量上，计算不同图片人脸特征的距离。通过相同人脸的距离总是小于不同人脸的距离，这一先验知识训练网络，进而可以直接对比2个人脸经过它的网络映射之后的欧式距离，判断是否为同一人。

### FaceNet测试使用

FaceNet 测试使用：因为 FaceNet 只需要计算人脸特征，然后计算距离使用阈值即可判定两张人脸照片是否属于相同的个体，所以在使用 FaceNet 时可以使用已经训练好的模型，也可以自己训练模型，最后根据两幅人像的欧几里得距离去判断两个人像的相似程度：两个人像之间的欧几里得距离越近，说明它们越相似。从初级应用的角度来看，已经训练好的模型已经足够强大，我们只需将一个基准图片与待分类图片通过 FaceNet 模型比较欧几里得距离，即可完成人脸识别任务。

### FaceNet人脸比对的判断

FaceNet人脸比对的判断：该算法主要用于验证人脸是否为同一个人，通过“人脸识别这个人是谁”完成人脸比对。判断依据是“两幅人像的欧几里得距离”，如给定一个阈值a=1，那么：当特征距离等于0的时候，认为是同一张图片（同一个人）；当特征距离小于1的时候，认为是同一个人；特征距离大于1的时候,认为不是同一个人。

![FaceNet人脸比对的判断](figures/FaceNet人脸比对的判断.jpg)

### FaceNet数据集

FaceNet数据集：

(1)训练数据,包括10575个人，共453453张图片,可以从http://www.cbsr.ia.ac.cn/english/CASIA-WebFace-Database.html 下载。

(2)验证数据集包含13000张图片,可以从http://vis-www.cs.umass.edu/lfw/ 地方下载,大约180M。

训练数据中，目录名是人名，目录下的文件是对应人的照片。



## MTCNN 与 FaceNet

**FaceNet**”人脸对齐对齐“的实现，是采用基于深度学习方法的 mtcnn人脸检测系统。github上的facenet工程，提供了用于人脸检测的MTCNN接口。

github上的 facenet 工程，为了便于测试，MTCNN 也一放在了工程文件中，在工程中的位置是src/align/detect_face.py，MTCNN的参数模型也保存在align文件夹下，分别是det1.npy,det2.npy,det3.npy。MTCNN的用法是先将网络搭建出来，定位input中的人脸的位置，然后返回自己设置的固定大小的脸部crop，然后再将其输入facenet就可以了。MTCNN目的是为了“人脸检测+定位+对齐”，因为当前的首要任务是让工程能跑起来，并且对其有一个大体的认识，方便后面的学习，具体的实现原理和代码解读，以及物体的检测发展历史，目前的发展方向，各种检测的算法，暂不作笔记。

可见，FaceNet提供训练数据的对齐(align)功能，它能自动完成待训练或者待测试图片的人脸检测并缩放为指定大小尺寸的JPEG数据以供训练或测试。



